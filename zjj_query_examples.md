# zjj Query System - Example Outputs

Generated by QA Agent #16 on 2026-02-07

---

## 1. session-exists

Check if a session exists by name.

```bash
$ zjj query session-exists my-session
```

**Output (session doesn't exist):**
```json
{
  "$schema": "zjj://query-session-exists/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "exists": false
}
```

**Output (session exists):**
```json
{
  "$schema": "zjj://query-session-exists/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "exists": true,
  "name": "my-session",
  "state": "active",
  "branch": "my-session",
  "changes": 3,
  "beads": "5/0/0"
}
```

---

## 2. session-count

Count total sessions or filter by status.

```bash
$ zjj query session-count
```

**Output:**
```
14
```

Note: Returns plain number, not JSON.

---

## 3. can-run

Check if a command can run and show blockers.

```bash
$ zjj query can-run add
```

**Output (can run):**
```json
{
  "$schema": "zjj://query-can-run/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "can_run": true,
  "command": "add",
  "blockers": [],
  "prerequisites_met": 4,
  "prerequisites_total": 4
}
```

**Output (cannot run - missing Zellij):**
```json
{
  "$schema": "zjj://query-can-run/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "can_run": false,
  "command": "add",
  "blockers": [
    {
      "check": "zellij_running",
      "status": false,
      "message": "Zellij is not running"
    }
  ],
  "prerequisites_met": 3,
  "prerequisites_total": 4
}
```

---

## 4. suggest-name

Suggest next available name based on pattern.

```bash
$ zjj query suggest-name "feature-{n}"
```

**Output:**
```json
{
  "$schema": "zjj://query-suggest-name/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "pattern": "feature-{n}",
  "suggested": "feature-1",
  "next_available_n": 1,
  "existing_matches": []
}
```

**Output (with conflicts):**
```json
{
  "$schema": "zjj://query-suggest-name/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "pattern": "feature-{n}",
  "suggested": "feature-4",
  "next_available_n": 4,
  "existing_matches": ["feature-1", "feature-2", "feature-3"]
}
```

**Error (no {n} placeholder):**
```
Error: Validation error: Pattern must contain {n} placeholder
```

---

## 5. lock-status

Check if a session is locked.

```bash
$ zjj query lock-status my-session
```

**Output (not locked):**
```json
{
  "$schema": "zjj://query-lock-status/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "session": "my-session",
  "locked": false,
  "holder": null,
  "expires_at": null,
  "error": null
}
```

**Output (locked):**
```json
{
  "$schema": "zjj://query-lock-status/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "session": "my-session",
  "locked": true,
  "holder": "agent-42",
  "expires_at": "2026-02-07T15:30:00Z",
  "error": null
}
```

**Output (session not found):**
```json
{
  "$schema": "zjj://query-lock-status/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "session": "nonexistent",
  "locked": false,
  "holder": null,
  "expires_at": null,
  "error": {
    "code": "SESSION_NOT_FOUND",
    "message": "Session 'nonexistent' not found"
  }
}
```

---

## 6. can-spawn

Check if spawning a session is possible.

```bash
$ zjj query can-spawn zjj-abc12
```

**Output (can spawn):**
```json
{
  "$schema": "zjj://query-can-spawn/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "can_spawn": true,
  "bead_id": "zjj-abc12",
  "reason": null,
  "blockers": []
}
```

**Output (cannot spawn):**
```json
{
  "$schema": "zjj://query-can-spawn/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "can_spawn": false,
  "bead_id": "zjj-abc12",
  "reason": "Bead 'zjj-abc12' not found",
  "blockers": [
    "Bead 'zjj-abc12' not found"
  ]
}
```

---

## 7. pending-merges

List sessions with changes ready to merge.

```bash
$ zjj query pending-merges
```

**Output (no pending merges):**
```json
{
  "$schema": "zjj://query-pending-merges/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "sessions": [],
  "count": 0,
  "error": null
}
```

**Output (with pending merges):**
```json
{
  "$schema": "zjj://query-pending-merges/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "sessions": [
    {
      "name": "feature-1",
      "branch": "feature-1",
      "changes": 5,
      "beads": "3/0/0",
      "ready": true
    },
    {
      "name": "bugfix-2",
      "branch": "bugfix-2",
      "changes": 2,
      "beads": "1/0/0",
      "ready": true
    }
  ],
  "count": 2,
  "error": null
}
```

---

## 8. location

Quick check of current location (main or workspace).

```bash
$ zjj query location
```

**Output (on main):**
```json
{
  "$schema": "zjj://query-location/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "type": "main",
  "name": null,
  "path": null,
  "simple": "main",
  "error": null
}
```

**Output (in workspace):**
```json
{
  "$schema": "zjj://query-location/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true,
  "type": "workspace",
  "name": "my-session",
  "path": "/home/user/.zjj/workspaces/my-session",
  "simple": "workspace:my-session",
  "error": null
}
```

---

## Common SchemaEnvelope Structure

All JSON queries follow this structure:

```json
{
  "$schema": "zjj://query-{type}/v1",
  "_schema_version": "1.0",
  "schema_type": "single",
  "success": true|false,
  "{query-specific-fields}": "..."
}
```

**Fields:**
- `$schema` - Schema URL identifying query type
- `_schema_version` - Version string (currently "1.0")
- `schema_type` - Usually "single"
- `success` - Boolean indicating if query succeeded
- Query-specific fields follow

---

## Error Handling

### Unknown Query Type

```bash
$ zjj query invalid-type
```

**Output:**
```
Error: Unknown query type 'invalid-type'

Available query types:

  session-exists - Check if a session exists by name
    Example: zjj query session-exists my-session

  session-count - Count total sessions or filter by status
    Example: zjj query session-count --status=active

  can-run - Check if a command can run and show blockers
    Example: zjj query can-run add

  suggest-name - Suggest next available name based on pattern
    Example: zjj query suggest-name "feature-{n}"

  lock-status - Check if a session is locked
    Example: zjj query lock-status my-session

  can-spawn - Check if spawning a session is possible
    Example: zjj query can-spawn zjj-abc12

  pending-merges - List sessions with changes ready to merge
    Example: zjj query pending-merges

  location - Quick check of current location (main or workspace)
    Example: zjj query location
```

### Missing Required Arguments

```bash
$ zjj query can-run
```

**Output:**
```
Error: 'can-run' query requires a argument

Description:
  Check if a command can run and show blockers

Usage:
  can-run <command_name>

Example:
  zjj query can-run add

Returns:
  {"can_run": true, "command": "add", "blockers": [], "prerequisites_met": 4, "prerequisites_total": 4}
```

---

## Exit Codes

⚠️ **Note:** There is an exit code inconsistency issue.

- ✅ `session-count` - Returns 0 on success
- ✅ `suggest-name` - Returns 0 on success
- ✅ `location` - Returns 0 on success
- ⚠️ `session-exists` - Returns 1 even on success (BUG)
- ⚠️ `can-run` - Returns 1 even on success (BUG)

**Recommendation:** Always parse JSON `success` field rather than relying on exit codes.

---

## Usage in Scripts

### Check if session exists:

```bash
#!/bin/bash
result=$(zjj query session-exists my-session)
exists=$(echo "$result" | jq -r '.exists')

if [ "$exists" = "true" ]; then
    echo "Session exists"
else
    echo "Session does not exist"
fi
```

### Get suggested name:

```bash
#!/bin/bash
result=$(zjj query suggest-name "feature-{n}")
suggested=$(echo "$result" | jq -r '.suggested')
echo "Next available name: $suggested"
```

### Check if command can run:

```bash
#!/bin/bash
result=$(zjj query can-run add)
can_run=$(echo "$result" | jq -r '.can_run')

if [ "$can_run" = "true" ]; then
    echo "Command can run"
    zjj add my-session
else
    echo "Cannot run command:"
    echo "$result" | jq -r '.blockers[].message'
fi
```

---

**Generated by QA Agent #16**
